System information Have written custom opposed using stock script provided TensorFlow Yes script testing nccl reduce sum attached OS Platform Distribution Linux Ubuntu Linux Ubuntu TensorFlow installed binary Binary TensorFlow command CUDA cuDNN GPU memory Gb Describe current behavior nccl reduce sum throws error feed devices fetch devices graph nccl reduce works Describe expected behavior Expect get reduced Code reproduce ops nccl ops nccl gpu constant dtype float gpu constant dtype float gpu nccl reduce sum sess Session print sess Other info logs ubuntu ip ~ tensorpack examples ResNet $ test nccl platform cpu feature guard Your CPU supports instructions TensorFlow binary compiled AVX FMA stream executor cuda cuda gpu executor successful NUMA read SysFS negative value must least one NUMA returning NUMA zero stream executor cuda cuda gpu executor successful NUMA read SysFS negative value must least one NUMA returning NUMA zero stream executor cuda cuda gpu executor successful NUMA read SysFS negative value must least one NUMA returning NUMA zero stream executor cuda cuda gpu executor successful NUMA read SysFS negative value must least one NUMA returning NUMA zero compiler xla service service XLA service executing computations platform CUDA Devices compiler xla service service StreamExecutor Tesla V SXM GB Compute Capability compiler xla service service StreamExecutor Tesla V SXM GB Compute Capability compiler xla service service StreamExecutor Tesla V SXM GB Compute Capability compiler xla service service StreamExecutor Tesla V SXM GB Compute Capability platform profile utils cpu utils CPU Frequency Hz compiler xla service service XLA service bbd f executing computations platform Host Devices compiler xla service service StreamExecutor undefined undefined common runtime gpu gpu Found properties name Tesla V SXM GB major minor memoryClockRate GHz pciBusID totalMemory GiB freeMemory GiB common runtime gpu gpu Found properties name Tesla V SXM GB major minor memoryClockRate GHz pciBusID totalMemory GiB freeMemory GiB common runtime gpu gpu Found properties name Tesla V SXM GB major minor memoryClockRate GHz pciBusID totalMemory GiB freeMemory GiB common runtime gpu gpu Found properties name Tesla V SXM GB major minor memoryClockRate GHz pciBusID totalMemory GiB freeMemory GiB common runtime gpu gpu Adding visible gpu devices common runtime gpu gpu Device interconnect StreamExecutor strength edge matrix common runtime gpu gpu common runtime gpu gpu Y Y Y common runtime gpu gpu Y Y Y common runtime gpu gpu Y Y Y common runtime gpu gpu Y Y Y common runtime gpu gpu Created TensorFlow job localhost replica task GPU MB memory physical GPU name Tesla V SXM GB pci bus id compute capability common runtime gpu gpu Created TensorFlow job localhost replica task GPU MB memory physical GPU name Tesla V SXM GB pci bus id compute capability common runtime gpu gpu Created TensorFlow job localhost replica task GPU MB memory physical GPU name Tesla V SXM GB pci bus id compute capability common runtime gpu gpu Created TensorFlow job localhost replica task GPU MB memory physical GPU name Tesla V SXM GB pci bus id compute capability Traceback recent call last home ubuntu venv packages client session call args home ubuntu venv packages client session options feed dict fetch list target list metadata home ubuntu venv packages client session call sessionrun metadata framework errors impl InvalidArgumentError NcclReduce specified either feed devices fetch devices Graph During handling exception exception occurred Traceback recent call last test nccl module print sess home ubuntu venv packages client session metadata ptr home ubuntu venv packages client session feed dict options metadata home ubuntu venv packages client session metadata home ubuntu venv packages client session call raise op message framework errors impl InvalidArgumentError NcclReduce specified either feed devices fetch devices Graph Check checkpoints available TF TRT quantization test Use constant test tensors instead tensors Otherwise test sometimes fails depending generated values This PR tries fix The root cause shared iterator resource private kernel resource cannot released ~ IteratorHandleOp blob master kernels iterator ops L L ResourceMgr Clear blob master framework resource mgr L L needs called free shared resources For case session close tries release shared resources calling ResourceMgr Clear generator dataset finish iteration yet needs delete generator calling finalizing function blob master kernels generator dataset op L However running finalizing function done function blob master kernels captured function L triggers ResourceMgr CleanUp blob master framework resource mgr L L causes deadlock ResourceMgr Clear Here Traceback frame fff libsystem kernel dylib psynch cvwait frame fff libsystem pthread dylib pthread cond wait frame fff libc dylib condition variable wait unique lock mutex frame libtensorflow framework nsync nsync mu semaphore p nsync nsync semaphore frame libtensorflow framework nsync nsync mu lock slow nsync nsync mu nsync waiter unsigned nsync lock frame libtensorflow framework nsync nsync mu lock nsync nsync mu frame bbe cf libtensorflow framework ResourceMgr Cleanup basic string traits allocator const frame pywrap internal function func CapturedFunction RunInstantiated vector allocator const vector allocator $ allocator CapturedFunction RunInstantiated vector allocator const vector allocator $ void basic string traits allocator const operator basic string traits allocator const frame ca pywrap internal ScopedStepContainer ~ ScopedStepContainer frame pywrap internal CapturedFunction RunInstantiated vector allocator const vector allocator frame eb pywrap internal GeneratorDatasetOp Dataset Iterator ~ Iterator frame eb pywrap internal GeneratorDatasetOp Dataset Iterator ~ Iterator frame eaea pywrap internal anonymous namespace FlatMapDatasetOp Dataset Iterator ~ Iterator frame fff libc dylib shared weak count release shared frame ec pywrap internal IteratorResource ~ IteratorResource frame ec pywrap internal IteratorResource ~ IteratorResource frame bbe fa libtensorflow framework ResourceMgr Clear frame f f pywrap internal DirectSession ~ DirectSession frame f aae pywrap internal DirectSession ~ DirectSession frame fff libc dylib shared weak count release shared frame ceb f pywrap internal SessionRef Close frame f pywrap internal TF CloseSession jsimsa We may locate exact statement exception raiased 